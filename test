// -------------------------------------------------------
// Ð’Ñ€ÑŠÑ‰Ð° Ð¼Ð°ÑÐ¸Ð²Ð¸ Ñ Ð´Ð°Ñ‚Ð¸, COB elapsed Ð¸ RR elapsed Ð² Ñ‡Ð°ÑÐ¾Ð²Ðµ
// -------------------------------------------------------
function getElapsedChartData() {
  const table = document.getElementById("recordsTable");
  // Ð’Ð·Ð¸Ð¼Ð°Ð¼Ðµ Ð²ÑÐ¸Ñ‡ÐºÐ¸ Ñ€ÐµÐ´Ð¾Ð²Ðµ (Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°Ð¼Ðµ header-Ð°)
  const rows = Array.from(table.getElementsByTagName("tr")).slice(1);

  // Ð’Ð·ÐµÐ¼Ð°Ð¼Ðµ ÐºÐ¾Ð»ÐºÐ¾ Ð´Ð½Ð¸ Ð´Ð° Ð¿Ð¾ÐºÐ°Ð¶ÐµÐ¼ (Ð¿Ð¾ ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚ Ð¾Ñ‚ slider-Ð°)
  const rangeInput = document.getElementById("daysRange");
  const maxDays = rangeInput ? parseInt(rangeInput.value, 10) : 10;

  const dates = [];
  const cobElapsed = [];
  const rrElapsed = [];

  // ÐžÐ±Ñ…Ð¾Ð´ Ð½Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ‚Ðµ maxDays Ñ€ÐµÐ´Ð°
  for (let i = rows.length - 1; i >= 0 && dates.length < maxDays; i--) {
    const cells = rows[i].getElementsByTagName("td");
    if (cells.length >= 9) {
      const date = cells[0].innerText.trim();
      const cobVal = cells[4].innerText.trim();
      const rrVal = cells[8].innerText.trim();

      if (date && cobVal && rrVal) {
        dates.push(date);
        cobElapsed.push(parseElapsedToHours(cobVal));
        rrElapsed.push(parseElapsedToHours(rrVal));
      }
    }
  }

  // ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð¾, Ð·Ð° Ð´Ð° ÑÐ° Ð² Ñ…Ñ€Ð¾Ð½Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÐ½ Ñ€ÐµÐ´
  dates.reverse();
  cobElapsed.reverse();
  rrElapsed.reverse();

  return { dates, cobElapsed, rrElapsed };
}


// -------------------------------------------------------
// Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ñ€Ð° Ð±Ð°Ñ€-Ñ‡Ð°Ñ€Ñ‚ Ñ dynamic resize Ð¸ Ð¾Ñ€Ð°Ð·Ð¼ÐµÑ€ÑÐ²Ð°Ð½Ðµ
// -------------------------------------------------------
let elapsedChartInstance;

function renderElapsedChart() {
  // 1) Ð’Ð·ÐµÐ¼Ð°Ð¼Ðµ Ð´Ð°Ð½Ð½Ð¸Ñ‚Ðµ
  const { dates, cobElapsed, rrElapsed } = getElapsedChartData();

  // 2) Ð˜Ð·Ñ‡Ð¸ÑÐ»ÑÐ²Ð°Ð¼Ðµ Ð²Ð¸ÑÐ¾Ñ‡Ð¸Ð½Ð°Ñ‚Ð° Ð½Ð° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°
  const perDayHeight = 12;      // Ð¿Ð¸ÐºÑÐµÐ»Ð° Ð½Ð° Ð´ÐµÐ½
  const minHeight = 200;        // Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»Ð½Ð° Ð²Ð¸ÑÐ¾Ñ‡Ð¸Ð½Ð°
  const maxHeight = 800;        // Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»Ð½Ð° Ð²Ð¸ÑÐ¾Ñ‡Ð¸Ð½Ð°
  const neededHeight = Math.min(
    maxHeight,
    Math.max(minHeight, dates.length * perDayHeight + 100)
  );
  const container = document.querySelector('.chart-container');
  container.style.height = neededHeight + 'px';

  // 3) Ð£Ð±Ð¸Ð¹Ð²Ð°Ð¼Ðµ Ð¿Ñ€ÐµÐ´Ð¸ÑˆÐµÐ½ Ð¸Ð½ÑÑ‚Ð°Ð½Ñ, Ð°ÐºÐ¾ Ð¸Ð¼Ð°
  if (elapsedChartInstance) {
    elapsedChartInstance.destroy();
  }

  // 4) Ð¡ÑŠÐ·Ð´Ð°Ð²Ð°Ð¼Ðµ Ð½Ð¾Ð²Ð¸Ñ Chart.js
  const ctx = document.getElementById("elapsedChart").getContext("2d");
  elapsedChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'COB Elapsed',
          data: cobElapsed,
          backgroundColor: 'rgba(154, 200, 245, 1)',
          stack: 'stack1',
          order: 1
        },
        {
          label: 'RR Elapsed',
          data: rrElapsed,
          backgroundColor: 'rgba(181, 181, 181, 1)',
          stack: 'stack1',
          order: 2
        },
        {
          label: 'Duration Limit (2:30)',
          data: Array(dates.length).fill(2.5),
          type: 'line',
          borderColor: 'red',
          borderDash: [6, 4],
          pointRadius: 0,
          borderWidth: 2,
          order: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: { top: 20, bottom: 20, left: 10, right: 10 }
      },
      scales: {
        x: {
          stacked: true,
          ticks: {
            autoSkip: true,
            maxTicksLimit: 10,
            maxRotation: 45,
            minRotation: 45
          }
        },
        y: {
          beginAtZero: true,
          max: 7,
          ticks: {
            maxTicksLimit: 8,
            callback: function(value) {
              return formatHHMM(value);
            }
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${formatHHMM(context.raw)}`;
            }
          }
        },
        title: {
          display: true,
          text: 'COB & RR Elapsed Times vs Duration Limit',
          color: getTextColor(),
          font: { size: 13, weight: 'bold' }
        },
        legend: {
          labels: { font: { size: 13 } }
        }
      }
    },
    plugins: [{
      // Ð½Ð¾ÑÐµÑ‰ plugin Ð·Ð° Ð¿Ð¸ÑÐ°Ð½Ðµ Ð½Ð° ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚Ð¸ Ð²ÑŠÑ‚Ñ€Ðµ Ð² ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸Ñ‚Ðµ
      id: 'customLabels',
      afterDatasetsDraw(chart) {
        const { ctx, data, scales } = chart;
        const cobMeta = chart.getDatasetMeta(0);
        const rrMeta  = chart.getDatasetMeta(1);
        const yScale  = scales.y;

        ctx.save();
        ctx.font = 'bold 11px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = getTextColor();

        data.labels.forEach((_, i) => {
          const cob = data.datasets[0].data[i];
          const rr  = data.datasets[1].data[i];
          const total = cob + rr;
          const x = cobMeta.data[i].x;
          const cobTop = yScale.getPixelForValue(cob);
          const rrTop  = yScale.getPixelForValue(total);

          // COB Ð²ÑŠÑ‚Ñ€Ðµ Ð² ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°Ñ‚Ð°
          if (cob > 0) {
            const yCobCenter = (yScale.getPixelForValue(0) + cobTop) / 2;
            ctx.fillText(formatHHMM(cob), x, yCobCenter);
          }
          // RR Ð²ÑŠÑ‚Ñ€Ðµ Ð² ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°Ñ‚Ð°
          if (rr > 0) {
            const yRrCenter = (cobTop + rrTop) / 2;
            ctx.fillText(formatHHMM(rr), x, yRrCenter);
          }
          // Ð¾Ð±Ñ‰Ð¾ Ð²Ñ€ÐµÐ¼Ðµ Ð½Ð°Ð´ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°Ñ‚Ð°
          if (total > 0) {
            ctx.fillText(formatHHMM(total), x, rrTop - 6);
          }
        });

        ctx.restore();
      }
    }]
  });
}







<table class="rounded" id="elapsedTable">
  <tr><th colspan="10">ðŸ“Š COB & RR Elapsed Times vs Duration Limit</th></tr>
  <tr>
    <td>
      <div class="chart-container">
        <canvas id="elapsedChart"></canvas>
      </div>
    </td>
  </tr>
</table>


.chart-container {
  width: 100%;
  overflow-x: auto;
}

#elapsedChart {
  width: 100% !important;
  height: 400px !important;
}


function renderElapsedChart() {
  const ctx = document.getElementById("elapsedChart").getContext("2d");
  const { dates, cobElapsed, rrElapsed } = getElapsedChartData();

  const canvas = document.getElementById("elapsedChart");
  
  // Ð—Ð°Ð´Ð°Ð²Ð°Ð¼Ðµ ÑˆÐ¸Ñ€Ð¸Ð½Ð°Ñ‚Ð° ÑÐ¿Ñ€ÑÐ¼Ð¾ Ð±Ñ€Ð¾Ñ Ð´Ð½Ð¸
  canvas.width = Math.max(dates.length * 100, 1000);

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'COB Elapsed',
          data: cobElapsed,
          backgroundColor: 'rgba(154, 200, 245, 1)',
          stack: 'stack1',
          order: 1
        },
        {
          label: 'RR Elapsed',
          data: rrElapsed,
          backgroundColor: 'rgba(181, 181, 181, 1)',
          stack: 'stack1',
          order: 2
        },
        {
          label: 'Duration Limit (2:30)',
          data: Array(dates.length).fill(2.5),
          type: 'line',
          borderColor: 'red',
          borderDash: [6, 4],
          pointRadius: 0,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 7,
          ticks: {
            callback: function(value) {
              return formatHHMM(value);
            }
          },
          stacked: true
        },
        x: {
          stacked: true,
          ticks: {
            autoSkip: false,
            font: { size: 13 },
            color: '#333'
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${formatHHMM(context.raw)}`;
            }
          }
        },
        title: {
          display: true,
          text: 'COB & RR Elapsed Times vs Duration Limit',
          color: getTextColor(),
          font: {
            size: 13,
            weight: 'bold'
          }
        },
        legend: {
          labels: {
            font: { size: 13 }
          }
        }
      },
      plugins: [{
        id: 'customLabels',
        afterDatasetsDraw(chart) {
          const { ctx, chartArea, data, scales } = chart;
          const cobMeta = chart.getDatasetMeta(0);
          const rrMeta = chart.getDatasetMeta(1);
          const y = scales.y;

          ctx.save();
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';

          const canvasBgColor = getComputedStyle(ctx.canvas).backgroundColor;
          const canvasHexColor = rgbToHex(canvasBgColor);
          ctx.fillStyle = getTextColor(canvasHexColor);

          data.labels.forEach((label, i) => {
            const cob = data.datasets[0].data[i];
            const rr = data.datasets[1].data[i];
            const total = cob + rr;

            const x = cobMeta.data[i].x;
            const cobTop = y.getPixelForValue(cob);
            const rrTop = y.getPixelForValue(total);

            if (cob > 0) {
              const cobCenterY = (y.getPixelForValue(0) + cobTop) / 2;
              ctx.fillText(formatHHMM(cob), x, cobCenterY);
            }

            if (rr > 0) {
              const rrCenterY = (cobTop + rrTop) / 2;
              ctx.fillText(formatHHMM(rr), x, rrCenterY);
            }

            if (total > 0) {
              ctx.fillText(formatHHMM(total), x, rrTop - 8);
            }
          });

          ctx.restore();
        }
      }]
    }
  });
}




<table class="rounded" id="elapsedTable">
  <tr><th colspan="10">ðŸ“Š COB & RR Elapsed Times vs Duration Limit</th></tr>
  <tr>
    <td>
      <div class="chart-container">
        <canvas id="elapsedChart"></canvas>
      </div>
    </td>
  </tr>
</table>


.chart-container {
  width: 100%;
  overflow-x: auto;
}

#elapsedChart {
  width: 100% !important;
  height: 400px !important;
}


function renderElapsedChart() {
  const ctx = document.getElementById("elapsedChart").getContext("2d");
  const { dates, cobElapsed, rrElapsed } = getElapsedChartData();

  const canvas = document.getElementById("elapsedChart");
  
  // Ð—Ð°Ð´Ð°Ð²Ð°Ð¼Ðµ ÑˆÐ¸Ñ€Ð¸Ð½Ð°Ñ‚Ð° ÑÐ¿Ñ€ÑÐ¼Ð¾ Ð±Ñ€Ð¾Ñ Ð´Ð½Ð¸
  canvas.width = Math.max(dates.length * 100, 1000);

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'COB Elapsed',
          data: cobElapsed,
          backgroundColor: 'rgba(154, 200, 245, 1)',
          stack: 'stack1',
          order: 1
        },
        {
          label: 'RR Elapsed',
          data: rrElapsed,
          backgroundColor: 'rgba(181, 181, 181, 1)',
          stack: 'stack1',
          order: 2
        },
        {
          label: 'Duration Limit (2:30)',
          data: Array(dates.length).fill(2.5),
          type: 'line',
          borderColor: 'red',
          borderDash: [6, 4],
          pointRadius: 0,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 7,
          ticks: {
            callback: function(value) {
              return formatHHMM(value);
            }
          },
          stacked: true
        },
        x: {
          stacked: true,
          ticks: {
            autoSkip: false,
            font: { size: 13 },
            color: '#333'
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${formatHHMM(context.raw)}`;
            }
          }
        },
        title: {
          display: true,
          text: 'COB & RR Elapsed Times vs Duration Limit',
          color: getTextColor(),
          font: {
            size: 13,
            weight: 'bold'
          }
        },
        legend: {
          labels: {
            font: { size: 13 }
          }
        }
      },
      plugins: [{
        id: 'customLabels',
        afterDatasetsDraw(chart) {
          const { ctx, chartArea, data, scales } = chart;
          const cobMeta = chart.getDatasetMeta(0);
          const rrMeta = chart.getDatasetMeta(1);
          const y = scales.y;

          ctx.save();
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';

          const canvasBgColor = getComputedStyle(ctx.canvas).backgroundColor;
          const canvasHexColor = rgbToHex(canvasBgColor);
          ctx.fillStyle = getTextColor(canvasHexColor);

          data.labels.forEach((label, i) => {
            const cob = data.datasets[0].data[i];
            const rr = data.datasets[1].data[i];
            const total = cob + rr;

            const x = cobMeta.data[i].x;
            const cobTop = y.getPixelForValue(cob);
            const rrTop = y.getPixelForValue(total);

            if (cob > 0) {
              const cobCenterY = (y.getPixelForValue(0) + cobTop) / 2;
              ctx.fillText(formatHHMM(cob), x, cobCenterY);
            }

            if (rr > 0) {
              const rrCenterY = (cobTop + rrTop) / 2;
              ctx.fillText(formatHHMM(rr), x, rrCenterY);
            }

            if (total > 0) {
              ctx.fillText(formatHHMM(total), x, rrTop - 8);
            }
          });

          ctx.restore();
        }
      }]
    }
  });
}
