<script>
Chart.register(ChartDataLabels);

function parseElapsedToHours(timeStr) {
    const parts = timeStr.split(':');
    if (parts.length === 3) {
        const h = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10);
        const s = parseInt(parts[2], 10);
        return h + m / 60 + s / 3600;
    }
    return 0;
}

function getElapsedChartData() {
    const table = document.getElementById("recordsTable");
    const rows = table.getElementsByTagName("tr");

    const dates = [];
    const cobElapsed = [], rrElapsed = [];

    for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        if (cells.length === 8) {
            const date = cells[0].innerText;
            const cob = parseElapsedToHours(cells[3].innerText);
            const rr = parseElapsedToHours(cells[7].innerText);

            dates.push(date);
            cobElapsed.push(cob);
            rrElapsed.push(rr);
        }
    }

    return { dates, cobElapsed, rrElapsed };
}

function renderElapsedChart() {
    const ctx = document.getElementById("elapsedChart").getContext("2d");
    const { dates, cobElapsed, rrElapsed } = getElapsedChartData();

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'COB Elapsed',
                    data: cobElapsed,
                    backgroundColor: 'orange',
                    stack: 'stack1'
                },
                {
                    label: 'RR Elapsed',
                    data: rrElapsed,
                    backgroundColor: 'gray',
                    stack: 'stack1'
                },
                {
                    label: 'Duration Limit (2:30)',
                    data: Array(dates.length).fill(2.5),
                    type: 'line',
                    borderColor: 'red',
                    borderDash: [6, 4],
                    pointRadius: 0,
                    borderWidth: 2,
                    order: 999
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                datalabels: {
                    color: 'black',
                    font: { weight: 'bold' },
                    formatter: function (value) {
                        const h = Math.floor(value);
                        const m = Math.round((value - h) * 60);
                        return `${h}:${m.toString().padStart(2, '0')}`;
                    },
                    anchor: 'center',
                    align: 'center'
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const value = context.raw;
                            const h = Math.floor(value);
                            const m = Math.round((value - h) * 60);
                            return `${context.dataset.label}: ${h}:${m.toString().padStart(2, '0')}`;
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'COB & RR Elapsed Times vs Duration Limit',
                    font: {
                        size: 18,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true
                },
                // Custom plugin for total above bars
                afterDatasetsDraw: function(chart) {
                    const {ctx, scales: {x, y}} = chart;

                    chart.data.labels.forEach((label, i) => {
                        const cob = chart.data.datasets[0].data[i];
                        const rr = chart.data.datasets[1].data[i];
                        const total = cob + rr;
                        const h = Math.floor(total);
                        const m = Math.round((total - h) * 60);
                        const text = `${h}:${m.toString().padStart(2, '0')}`;

                        const barX = x.getPixelForValue(i);
                        const barY = y.getPixelForValue(total);

                        ctx.save();
                        ctx.font = 'bold 12px sans-serif';
                        ctx.fillStyle = 'black';
                        ctx.textAlign = 'center';
                        ctx.fillText(text, barX, barY - 6);
                        ctx.restore();
                    });
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 7,
                    ticks: {
                        callback: function (value) {
                            const h = Math.floor(value);
                            const m = Math.round((value - h) * 60);
                            return `${h}:${m.toString().padStart(2, '0')}`;
                        }
                    },
                    title: {
                        display: true,
                        text: 'Duration (HH:mm)'
                    },
                    stacked: true
                },
                x: {
                    stacked: true
                }
            }
        },
        plugins: [{
            id: 'afterDatasetsDraw',
            afterDatasetsDraw(chart) {
                chart.options.plugins.afterDatasetsDraw(chart);
            }
        }]
    });
}

// Извикване
window.onload = function () {
    renderElapsedChart();
};
</script>
